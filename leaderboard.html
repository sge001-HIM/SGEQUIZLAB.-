<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Leaderboard ‚Äî SGEQUIZLAB</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0e0f0e;--bg2:#111311;--s:rgba(255,255,255,.04);--s2:rgba(255,255,255,.07);--b:rgba(255,255,255,.08);--e:#10d9a0;--ed:#0a9e75;--g:#f0c040;--gd:#b8923a;--bz:#cd7f32;--t:#e8ece8;--tm:#7a8a7a;--td:#4a584a;--d:#e05555;--r:16px;--rs:8px;--fd:'Cinzel',serif;--fb:'DM Sans',sans-serif}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--t);font-family:var(--fb);font-weight:300;min-height:100vh}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.035'/%3E%3C/svg%3E");pointer-events:none;z-index:999;opacity:.6}
.orb{position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none}
.o1{width:360px;height:360px;background:radial-gradient(circle,rgba(16,217,160,.08),transparent 70%);top:-90px;left:-90px}
.o2{width:300px;height:300px;background:radial-gradient(circle,rgba(240,192,64,.07),transparent 70%);bottom:-70px;right:-70px}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--ed);border-radius:3px}

header{position:sticky;top:0;z-index:50;background:rgba(14,15,14,.93);backdrop-filter:blur(16px);border-bottom:1px solid var(--b);padding:0 46px;height:64px;display:flex;align-items:center;justify-content:space-between}
.logo{font-family:var(--fd);font-size:.95rem;letter-spacing:.12em;color:var(--g);text-decoration:none}.logo span{color:var(--e)}
.hnav{display:flex;gap:9px}
.bns{background:var(--s);border:1px solid var(--b);color:var(--tm);border-radius:var(--rs);padding:7px 14px;font-family:var(--fb);font-size:.77rem;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all .2s}
.bns:hover{background:var(--s2);color:var(--t)}

main{max-width:820px;margin:0 auto;padding:50px 24px 80px}
.spin{display:inline-block;border-radius:50%;animation:spin .8s linear infinite}
.spin-lg{width:28px;height:28px;border:2px solid rgba(16,217,160,.12);border-top-color:var(--e)}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes ri{from{opacity:0;transform:translateX(-5px)}to{opacity:1;transform:translateX(0)}}

/* HERO */
.lbh{text-align:center;margin-bottom:42px}
.lbb{display:inline-flex;align-items:center;gap:8px;background:rgba(240,192,64,.07);border:1px solid rgba(240,192,64,.16);border-radius:100px;padding:5px 15px;font-size:.7rem;color:var(--g);letter-spacing:.12em;text-transform:uppercase;margin-bottom:17px}
.lbt{font-family:var(--fd);font-size:clamp(1.8rem,4vw,2.7rem);font-weight:900;letter-spacing:.06em;margin-bottom:9px}.lbt span{color:var(--g)}
.lbqn{font-size:.93rem;color:var(--tm);margin-bottom:4px}
.lbm{font-size:.77rem;color:var(--td)}

/* STATS */
.sr{display:flex;gap:13px;margin-bottom:32px;flex-wrap:wrap}
.sc{flex:1;min-width:120px;background:var(--s);border:1px solid var(--b);border-radius:var(--rs);padding:17px}
.sv{font-family:var(--fd);font-size:1.5rem;font-weight:600;color:var(--g)}
.sk{font-size:.69rem;color:var(--tm);letter-spacing:.08em;text-transform:uppercase;margin-top:3px}

/* PODIUM */
.pw{display:flex;align-items:flex-end;justify-content:center;gap:10px;margin-bottom:36px}
.ps{text-align:center}
.pc{background:var(--s);border:1px solid var(--b);border-radius:var(--r) var(--r) 0 0;padding:17px 13px 13px;min-width:126px;transition:transform .2s}
.pc:hover{transform:translateY(-2px)}
.pc.r1{border-color:rgba(240,192,64,.4);background:rgba(240,192,64,.04)}
.pc.r2{border-color:rgba(192,192,192,.24)}
.pc.r3{border-color:rgba(205,127,50,.24)}
.pm{font-size:1.85rem;margin-bottom:7px}
.pn{font-size:.81rem;font-weight:500;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:108px}
.psc{font-family:var(--fd);font-size:1.02rem;color:var(--g)}
.pp{font-size:.69rem;color:var(--tm);margin-top:2px}
.pbar{height:0}
.b1{height:76px;background:linear-gradient(180deg,rgba(240,192,64,.11),transparent)}
.b2{height:50px;background:linear-gradient(180deg,rgba(192,192,192,.07),transparent)}
.b3{height:34px;background:linear-gradient(180deg,rgba(205,127,50,.08),transparent)}

/* TABLE */
.tw{background:var(--s);border:1px solid var(--b);border-radius:var(--r);overflow:hidden}
.th{display:grid;grid-template-columns:50px 1fr 88px 88px 118px;padding:12px 17px;border-bottom:1px solid var(--b)}
.thd{font-size:.67rem;letter-spacing:.1em;text-transform:uppercase;color:var(--td);font-weight:500}
.thd.r{text-align:right}
.tr2{display:grid;grid-template-columns:50px 1fr 88px 88px 118px;padding:13px 17px;border-bottom:1px solid rgba(255,255,255,.03);align-items:center;transition:background .2s;animation:ri .35s ease both}
.tr2:last-child{border-bottom:none}
.tr2:hover{background:var(--s2)}
.rk{font-family:var(--fd);font-size:.9rem;font-weight:600;color:var(--td)}
.rk.gg{color:var(--g)}.rk.si{color:#c0c0c0}.rk.bz{color:var(--bz)}
.nc2{font-size:.87rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sc2{text-align:right;font-family:var(--fd);font-size:.9rem;font-weight:600;color:var(--e)}
.pc2{text-align:right;font-size:.82rem;color:var(--tm)}
.dc{text-align:right;font-size:.72rem;color:var(--td)}
.es{text-align:center;padding:50px 20px;color:var(--td);font-size:.87rem}
.es div:first-child{font-size:2.2rem;margin-bottom:9px;opacity:.3}

@media(max-width:600px){header{padding:0 17px}main{padding:28px 12px 60px}.th{grid-template-columns:40px 1fr 72px 62px}.tr2{grid-template-columns:40px 1fr 72px 62px}.dc,.thd:last-child{display:none}}
</style>
</head>
<body>
<div class="orb o1"></div>
<div class="orb o2"></div>
<header>
  <a href="index.html" class="logo">SGE<span>QUIZ</span>LAB</a>
  <div class="hnav">
    <a href="index.html" class="bns">üè† Home</a>
    <a href="admin.html" class="bns">‚öô Admin</a>
  </div>
</header>
<main>
  <div id="loading" style="text-align:center;padding:80px 0">
    <div class="spin spin-lg"></div>
    <p style="color:var(--tm);margin-top:13px;font-size:.87rem">Loading leaderboard‚Ä¶</p>
  </div>
  <div id="lbc" style="display:none">
    <div class="lbh">
      <div class="lbb">üèÜ Leaderboard</div>
      <h1 class="lbt">Top <span>Performers</span></h1>
      <div class="lbqn" id="lbqn"></div>
      <div class="lbm" id="lbm"></div>
    </div>
    <div class="sr" id="srow"></div>
    <div class="pw" id="podium" style="display:none"></div>
    <div class="tw">
      <div class="es" id="empty" style="display:none"><div>üì≠</div>No attempts yet. Share the quiz link to get started!</div>
      <div class="th" id="thead" style="display:none">
        <div class="thd">Rank</div>
        <div class="thd">Student</div>
        <div class="thd r">Score</div>
        <div class="thd r">Percent</div>
        <div class="thd r">Date</div>
      </div>
      <div id="tbody"></div>
    </div>
  </div>
</main>
<script type="module">
import { db } from './firebase.js';
import { doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

(async () => {
  const qid = new URLSearchParams(location.search).get('id');
  if (!qid) {
    document.getElementById('loading').innerHTML = '<div style="color:var(--d);text-align:center;padding:80px">No quiz ID in URL.</div>';
    return;
  }
  try {
    // Load quiz info first, then attempts separately so we can see which fails
    let qsnap, asnap;
    try {
      qsnap = await getDoc(doc(db, 'quizzes', qid));
    } catch(e) {
      throw new Error('Failed to load quiz info: ' + e.message);
    }
    try {
      asnap = await getDocs(query(
        collection(db, 'attempts'),
        where('quizId', '==', qid)
      ));
    } catch(e) {
      throw new Error('Failed to load attempts: ' + e.message);
    }

    const qtitle  = qsnap.exists() ? qsnap.data().title : 'Quiz';
    const qcount  = qsnap.exists() ? (qsnap.data().questions?.length || 0) : 0;
    // Sort by percentage desc, then timestamp asc ‚Äî no Firestore index needed
    const attempts = asnap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .sort((a, b) => {
        if (b.percentage !== a.percentage) return b.percentage - a.percentage;
        const ta = a.timestamp?.toMillis?.() || 0;
        const tb = b.timestamp?.toMillis?.() || 0;
        return ta - tb;
      });

    document.title = qtitle + ' ¬∑ Leaderboard ‚Äî SGEQUIZLAB';
    document.getElementById('loading').style.display = 'none';
    document.getElementById('lbc').style.display     = 'block';
    document.getElementById('lbqn').textContent = qtitle;
    document.getElementById('lbm').textContent  = qcount + ' questions ¬∑ ' + attempts.length + ' attempt' + (attempts.length !== 1 ? 's' : '');

    // Stats
    if (attempts.length > 0) {
      const avg = Math.round(attempts.reduce((s, a) => s + a.percentage, 0) / attempts.length);
      document.getElementById('srow').innerHTML = `
        <div class="sc"><div class="sv">${attempts.length}</div><div class="sk">Total Attempts</div></div>
        <div class="sc"><div class="sv">${attempts[0].percentage}%</div><div class="sk">Top Score</div></div>
        <div class="sc"><div class="sv">${avg}%</div><div class="sk">Average Score</div></div>`;
    }

    if (attempts.length === 0) { document.getElementById('empty').style.display = 'block'; return; }

    // Podium
    const podium = document.getElementById('podium');
    podium.style.display = 'flex';
    const medals = ['ü•á','ü•à','ü•â'], rk = ['r1','r2','r3'], bars = ['b1','b2','b3'];
    const order  = attempts.length >= 3 ? [1,0,2] : attempts.length === 2 ? [1,0] : [0];
    podium.innerHTML = order.map(i => {
      const a = attempts[i];
      if (!a) return '';
      return `<div class="ps">
        <div class="pc ${rk[i]}">
          <div class="pm">${medals[i]}</div>
          <div class="pn">${esc(a.studentName)}</div>
          <div class="psc">${a.score}/${a.total}</div>
          <div class="pp">${a.percentage}%</div>
        </div>
        <div class="pbar ${bars[i]}"></div>
      </div>`;
    }).join('');

    // Table
    document.getElementById('thead').style.display = 'grid';
    const tbody = document.getElementById('tbody');
    attempts.forEach((a, i) => {
      const rkcls = i === 0 ? 'gg' : i === 1 ? 'si' : i === 2 ? 'bz' : '';
      const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '#' + (i + 1);
      const d = a.timestamp
        ? new Date(a.timestamp.toDate()).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' })
        : '‚Äî';
      const row = document.createElement('div');
      row.className = 'tr2';
      row.style.animationDelay = (i * 0.04) + 's';
      row.innerHTML = `
        <div class="rk ${rkcls}">${medal}</div>
        <div class="nc2">${esc(a.studentName)}</div>
        <div class="sc2">${a.score}/${a.total}</div>
        <div class="pc2">${a.percentage}%</div>
        <div class="dc">${d}</div>`;
      tbody.appendChild(row);
    });

  } catch(e) {
    document.getElementById('loading').innerHTML = `<div style="color:var(--d);text-align:center;padding:80px;font-size:.85rem">
      <div style="font-size:2rem;margin-bottom:12px">‚ö†Ô∏è</div>
      <strong>Error loading leaderboard:</strong><br/><br/>
      ${e.message}<br/><br/>
      <span style="color:var(--td);font-size:.75rem">Code: ${e.code || 'unknown'}</span>
    </div>`;
  }
})();

function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
